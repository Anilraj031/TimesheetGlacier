{% extends "base.html" %}
{% block script %}
<title>Attendance</title>
<style>
  .dataTables_filter { display: none; }
</style>
<script>
$(document).ready(function(){
    is_admin = '{% if user.is_superuser %}True{% else %}False{% endif %}';
    getLocation();
  });
//gte latitude and longitude
//location
var mylocation = '';
var locationError = '';
function getLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(showPosition,showError);
  } else { 
      alert("Geolocation is not supported by this browser.");
  }
}

function showPosition(position) {
  mylocation = "" + position.coords.latitude + "," + position.coords.longitude;
}

function showError(error) {
  switch(error.code) {
    case error.PERMISSION_DENIED:
    locationError = "User denied the request for Geolocation."
      break;
    case error.POSITION_UNAVAILABLE:
    locationError = "Location information is unavailable."
      break;
    case error.TIMEOUT:
    locationError= "The request to get user location timed out."
      break;
    case error.UNKNOWN_ERROR:
    locationError = "An unknown error occurred."
      break;
  }
}
//location end
</script>
{% endblock %}
{% block content %}
<div class="">
  <div class="row">
    <div class="text-right w-50">
      {% csrf_token %}
    <select class="form-control form-control-sm w-25" id="year" style="float:left;" onchange="getMonthData()">
      <option value="2023">2023</option>
      <option value="2022">2022</option>
    </select>
      <select class="form-control form-control-sm col-xs-2 w-25" id="month" style="float:left;" onchange="getMonthData()">
        <option value="1">January</option>
        <option value="2">February</option>
        <option value="3">March</option>
        <option value="4">April</option>
        <option value="5">May</option>
        <option value="6">June</option>
        <option value="7">July</option>
        <option value="8">August</option>
        <option value="9">September</option>
        <option value="10">October</option>
        <option value="11">November</option>
        <option value="12">December</option>
      </select>
      {% if user.is_superuser or perms.Attendance.view_attendance %}
      <select class="form-control form-control-sm col-xs-2 w-25" id="user_s" style="float:left;" onchange="getMonthData()">
        <option value="{{user.id}}">{{user.username}}</option>
        {% for n in users %}
          {% if n.username != user.username %}
            <option class="active" value="{{n.id}}">{{n.username}}</option>
          {% endif %}
        {% endfor %}
        <option value="0">all</option>
      </select>
      {% endif %}
    </div>
    <div class="d-grid gap-2 d-md-flex justify-content-md-end w-50">
      <button class="btn btn-md btn-primary " style="display:{% if btn.btn1 == True %}none;{% elif btn.btn1 == False %}; {% endif %}" onclick="make_attendance('start'),start()" id="btnstart">Start</button>
      <button class="btn btn-md btn-danger " style="display:{% if btn.btn3 == True %}none;{% elif btn.btn3 == False %}; {% endif %}" onclick="pause(),make_attendance('stop')" id="btnstop">End</button>
      <button class="btn btn-md btn-warning " style="display:{% if btn.btn2 == True %}none;{% elif btn.btn2 == False %}; {% endif %}" onclick="pause(),make_attendance('break')" id="btnbreak1">Time Off</button>
      <button class="btn btn-md btn-warning " style="display:{% if btn.btn2 == False %}none;{% elif btn.btn2 == False %}; {% endif %}" onclick="start(),make_attendance('resume')" id="btnbreak2">Continue</button>
    </div>

  </div><br />
  <div class="table-wrap " style="float:clear">
      <table class="table table-hover  shadow " id="example" style="width:100%;">
        <thead id="thead">
          <tr>
            <th>Date</th>
            <th>Entry</th>
            <th>Break</th>
            <th>Exit</th>
            <th>Hour</th>
            {% if user.is_superuser %}<th>User</th><th style="width:1%;">Action</th>{% endif %}
          </tr>
        </thead>
        <tbody id="tbody">
          {% for n in result %}
          <tr><td>{{n.date}}</td><td>{{n.entry}}</td><td>{{n.lbreak1}}-{{n.lbreak2}}</td><td>{{n.exit}}</td><td>{{n.hour}}</td>
            {% if user.is_superuser %}
            <td>{{n.user.username}}</td>
            <td>
              <!-- <a href="{% url 'a_details1' attendance_id=n.id %}" id="a_details"><i class="fas fa-sharp fa-solid fa-location-arrow text-info"></i></a> -->
              <a onclick = "viewLocation({{n.id}})"  id="a_details" class="btn btn-info btn-sm bg-transparent p-2 border-0 pb-0"><i class="fas fa-sharp fa-solid fa-location-arrow text-info"></i></a>
            </td>
            {% endif %}
            </tr>
          {% endfor%}
        </tbody>
      </table>
    </div>
</div>

<!--view location modal-->
<div class="modal fade" id="locationModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
      <div class="modal-content rounded-0">
          <div class="modal-header">
              <h5 class="modal-title" id="exampleModalLabel">Users Location Details</h5>
              <button class="btn-close" type="button" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-sm-3">
                <h6 class="mb-0">SignIn</h6>
              </div>
              <div class="col-sm-9 text-secondary">
                <span id="startLocation">
              </div>
            </div>
            <div class="row mt-4">
              <div class="col-sm-3">
                <h6 class="mb-0">SignOut</h6>
              </div>
              <div class="col-sm-9 text-secondary">
                <span id="stopLocation">
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" type="button" data-bs-dismiss="modal">Close</button>
            
          </div>
      </div>
  </div>
</div>
<!-- end view location modal-->

<script>
 
  $(document).ready(function(){
    const d = new Date();
    let month = d.getMonth();
    document.getElementById("month").selectedIndex = month;
  });

  //for data table
  $(document).ready(function () {
    $('#example').dataTable({
      bInfo:true,
      pagingType: 'full_numbers',
      lengthChange: false
  });
});


  function getFirstDayOfMonth(year, month) {
      return new Date(year, month, 1);
    }
    

    function getDay(date)
    {
      const weekday = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
      const d = date;
      let day = weekday[d.getDay()];
      return day;
    }

    function make_attendance(type)
    {
      var secondss='';
      var html = '';
      var date=new Date();
      var f_date = date.getFullYear()+'-'+(date.getMonth()+1)+'-'+date.getDate();
      var day = getDay(date);
      var time1 = date.getHours()+':'+date.getMinutes();
      var data='';
      if(type == 'start')
      {
        if(mylocation != '')
        {
          //alert(mylocation);
          data ={date:f_date,day:day,entry:time1,start_location:mylocation,btn:1};
          $("#btnstart").hide();
          $("#btnbreak1").show();
          $("#btnstop").show();
        }
        else{
          alert(locationError);
        }
      }
      if(type == 'break')
      {
        if($("#btnstart").is(':hidden') == true)
        {
          data ={date:f_date,lbreak1:time1,btn:2};
          $("#btnbreak1").hide();
          $("#btnbreak2").show();
        }
        else{alert("You haven't started your work hours yet!")}
        
      }
      if(type == 'resume')
      {
        data ={date:f_date,lbreak2:time1,btn:3};
        $("#btnbreak1").show();
        $("#btnbreak2").hide();
      }
      if(type =='stop'){
        get_h = save_hr;
        get_m = save_min;
        w_hour = get_h+':'+get_m;
        alert(mylocation);
        data ={date:f_date,exit:time1,hour:w_hour,stop_location:mylocation,btn:4};
       
        var isHidden = $('#btnbreak2').is(':hidden');
        if( isHidden != false)
        {
          $("#btnstart").show();
          $("#btnstop").hide();
          $("#btnbreak1").hide();
          $("#btnbreak2").hide();
          reset();
        }
        else{
          alert("End your break first");
        }
      }
      if(data != ''){
        $.ajax({
          url: "{% url 'makeattendance' %}",
          method: "POST",
          data: data,
          success: function(data){
            dataset = [];
            dataset1 = [];
            for(i=0;i<data.attendance.length;i++)
            {
              dataset1.push(data.attendance[i].date,
              data.attendance[i].entry,
              data.attendance[i].lbreak1+'-'+data.attendance[i].lbreak2,
              data.attendance[i].exit,
              data.attendance[i].hour)
              if(is_admin=='True'){
                dataset1.push('<td>'+data.attendance[i].user+'</td>',
                '<td><a class="btn btn-info btn-sm bg-transparent p-2 border-0 pb-0" onclick = "viewLocation('+data.attendance[i].id+')" id="a_details"><i class="fas fa-sharp fa-solid fa-location-arrow text-info"></i></a></tr>')
              }
              dataset.push(dataset1);
              dataset1=[];
            }
            //console.log(dataset1)
            var table = $('#example').DataTable();
            table.clear();
            table.rows.add(dataset).draw();
          },
        });
      }
      
    }

    function getMonthData(){
      var month = $("#month").val();
      var year = $("#year").val();
      var user = $("#user_s").val();
      //alert(user);
      data = {month:month,year:year,user:user};
      html = '';
      $.ajax({
        url: "{% url 'getattendance' %}",
        method: "POST",
        data: data,
        success: function(data){
                //$('#example').DataTable().clear();
                dataset = [];
                dataset1 = [];
                for(i=0;i<data.attendance.length;i++)
                {
                  dataset1.push(data.attendance[i].date,
                  data.attendance[i].entry,
                  data.attendance[i].lbreak1+'-'+data.attendance[i].lbreak2,
                  data.attendance[i].exit,
                  data.attendance[i].hour)
                  if(is_admin=='True'){
                    dataset1.push('<td>'+data.attendance[i].user+'</td>',
                    //'<td><a href="Details/'+data.attendance[i].id+'" id="a_details"><i class="fas fa-sharp fa-solid fa-location-arrow text-info"></i></a></tr>')
                      '<td><a class="btn btn-info btn-sm bg-transparent p-2 border-0 pb-0" onclick = "viewLocation('+data.attendance[i].id+')" id="a_details"><i class="fas fa-sharp fa-solid fa-location-arrow text-info"></i></a></tr>')
                  }
                  dataset.push(dataset1);
                  dataset1=[];
                }
                //console.log(dataset1)
                var table = $('#example').DataTable();
                table.clear();
                table.rows.add(dataset).draw();
        },
    });
    }
    

    function viewLocation(id)
    {
      csr =$("input[name=csrfmiddlewaretoken]").val();
      data={id:id,csrfmiddlewaretoken:csr};
      $.ajax({
        url: "{% url 'a_details' %}",
        method: "POST",
        data: data,
        success: function(data){
          console.log(data.start);
          $("#startLocation").html(data.start)
          $("#stopLocation").html(data.stop)
          console.log(data.stop);
          $("#locationModal").modal('show');
        },
      });
    }
</script>
{% endblock %}